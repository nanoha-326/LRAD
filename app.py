import streamlit as st
from openai import OpenAI
import pandas as pd
import numpy as np
import re, os, json, unicodedata, base64
from datetime import datetime, timezone, timedelta
import gspread
from google.oauth2.service_account import Credentials
from sklearn.metrics.pairwise import cosine_similarity
import traceback
import random
import time

st.set_page_config(page_title="LRADãƒãƒ£ãƒƒãƒˆ", layout="centered")

# --- é€šå¸¸ã®ãƒ­ã‚°ã‚¤ãƒ³ï¼†ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸éƒ¨åˆ† --- #

CORRECT_PASSWORD = "mypassword"

if "authenticated" not in st.session_state:
    st.session_state["authenticated"] = False
if "show_welcome" not in st.session_state:
    st.session_state["show_welcome"] = False
if "welcome_message" not in st.session_state:
    st.session_state["welcome_message"] = ""
if "fade_out" not in st.session_state:
    st.session_state["fade_out"] = False

WELCOME_MESSAGES = [
    "ã‚ˆã†ã“ãï¼LRADãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã¸ã€‚",
    "ã‚ãªãŸã®ç–‘å•ã«ãŠå¿œãˆã—ã¾ã™ã€‚",
    "LRADå°‚ç”¨ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã§ã™ã€‚",
    "Welcome to the LRAD Chat Assistant.",
    "Your questions, our answers.",
]

def password_check():
    if not st.session_state["authenticated"]:
        with st.form("login_form"):
            st.title("ãƒ­ã‚°ã‚¤ãƒ³")
            password = st.text_input("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›", type="password")
            submitted = st.form_submit_button("ãƒ­ã‚°ã‚¤ãƒ³")
            if submitted:
                if password == CORRECT_PASSWORD:
                    st.session_state["authenticated"] = True
                    st.session_state["show_welcome"] = True
                    st.session_state["welcome_message"] = random.choice(WELCOME_MESSAGES)
                    st.session_state["fade_out"] = False
                    st.experimental_rerun()
                else:
                    st.error("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™")
        st.stop()

password_check()

def show_welcome_screen():
    st.markdown(
        f"""
        <style>
        .fullscreen {{
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 48px;
            font-weight: bold;
            animation: fadein 1.5s forwards;
            z-index: 9999;
        }}
        .fadeout {{
            animation: fadeout 1.5s forwards;
        }}
        @keyframes fadein {{
            from {{ opacity: 0; }}
            to {{ opacity: 1; }}
        }}
        @keyframes fadeout {{
            from {{ opacity: 1; }}
            to {{ opacity: 0; }}
        }}
        </style>
        <div class="fullscreen {'fadeout' if st.session_state['fade_out'] else ''}">
            {st.session_state['welcome_message']}
        </div>
        """,
        unsafe_allow_html=True,
    )

if st.session_state["show_welcome"]:
    show_welcome_screen()
    if not st.session_state["fade_out"]:
        time.sleep(2.0)
        st.session_state["fade_out"] = True
        st.experimental_rerun()
    else:
        time.sleep(1.5)
        st.session_state["show_welcome"] = False
        st.experimental_rerun()

# --- OpenAIåˆæœŸåŒ– --- #
try:
    client = OpenAI(api_key=st.secrets.OpenAIAPI.openai_api_key)
except Exception as e:
    st.error("OpenAI APIã‚­ãƒ¼ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚st.secretsã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
    st.error(traceback.format_exc())
    st.stop()

# --- ç”»åƒè¡¨ç¤º --- #
def get_base64_image(path):
    try:
        with open(path, "rb") as img_file:
            return base64.b64encode(img_file.read()).decode()
    except Exception as e:
        st.warning(f"ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")
        return ""

image_base64 = get_base64_image("LRADimg.png")

st.markdown(
    f"""
    <div style="display:flex; align-items:center;">
        <img src="data:image/png;base64,{image_base64}" width="80" style="margin-right:10px;">
        <h1 style="margin:0;">LRADã‚µãƒãƒ¼ãƒˆãƒãƒ£ãƒƒãƒˆ</h1>
    </div>
    """,
    unsafe_allow_html=True
)

st.caption("â€»ã“ã®ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã¯FAQã¨AIã‚’ã‚‚ã¨ã«å¿œç­”ã—ã¾ã™ãŒã€ã™ã¹ã¦ã®è³ªå•ã«æ­£ç¢ºã«å›ç­”ã§ãã‚‹ã¨ã¯é™ã‚Šã¾ã›ã‚“ã€‚")

# --- å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ --- #
def is_valid_input(text: str) -> bool:
    text = text.strip()
    if not (3 <= len(text) <= 300):
        return False
    if len(re.findall(r'[^A-Za-z0-9ã-ã‚“ã‚¡-ãƒ¶ä¸€-é¾ \s]', text)) / len(text) > 0.3:
        return False
    try:
        unicodedata.normalize("NFKC", text).encode("utf-8")
    except UnicodeError:
        return False
    return True

# --- Embeddingå–å¾— --- #
def get_embedding(text):
    text = text.replace("\n", " ")
    try:
        res = client.embeddings.create(input=[text], model="text-embedding-3-small")
        return res.data[0].embedding
    except Exception as e:
        st.error(f"åŸ‹ã‚è¾¼ã¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")
        return np.zeros(1536)

# --- FAQèª­ã¿è¾¼ã¿ --- #
@st.cache_data
def load_faq(path="faq_all_with_embed.csv"):
    def parse_embedding(val):
        try:
            return np.array(json.loads(val))
        except Exception:
            return np.zeros(1536)
    df = pd.read_csv(path)
    df["embedding"] = df["embedding"].apply(parse_embedding)
    return df

faq_df = load_faq()

@st.cache_data
def load_common_faq(path="faq_common.csv"):
    try:
        df = pd.read_csv(path)
        return df
    except Exception as e:
        st.error(f"ã‚ˆãã‚ã‚‹è³ªå•ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")
        return pd.DataFrame(columns=["è³ªå•", "å›ç­”"])

common_faq_df = load_common_faq()

with st.expander("ğŸ’¡ ã‚ˆãã‚ã‚‹è³ªå•", expanded=False):
    if not common_faq_df.empty:
        sample = common_faq_df.sample(1)
        for _, row in sample.iterrows():
            st.markdown(f"**Q. {row['è³ªå•']}**\n\nA. {row['å›ç­”']}")

# --- FAQé¡ä¼¼è³ªå•æ¤œç´¢ --- #
def find_top_similar(q, df, k=1):
    q_vec = get_embedding(q)
    try:
        faq_vecs = np.stack(df["embedding"].to_numpy())
        sims = cosine_similarity([q_vec], faq_vecs)[0]
        idx = sims.argsort()[::-1][:k][0]
        return df.iloc[idx]["è³ªå•"], df.iloc[idx]["å›ç­”"]
    except Exception:
        return None, None

# --- AIå›ç­”ç”Ÿæˆ --- #
def generate_response(user_q, ref_q, ref_a):
    system_prompt = (
        "ã‚ãªãŸã¯LRADï¼ˆé èµ¤å¤–ç·šé›»å­ç†±åˆ†è§£è£…ç½®ï¼‰ã®å°‚é–€å®¶ã§ã™ã€‚\n"
        f"FAQè³ªå•: {ref_q}\nFAQå›ç­”: {ref_a}\n"
        "ã“ã®æƒ…å ±ã‚’ã‚‚ã¨ã«200æ–‡å­—ä»¥å†…ã§ç°¡æ½”ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«ç­”ãˆã¦ãã ã•ã„ã€‚"
    )
    messages = [{"role": "system", "content": system_prompt}, {"role": "user", "content": user_q}]
    try:
        res = client.chat.completions.create(model="gpt-3.5-turbo", messages=messages, temperature=0.3)
        return res.choices[0].message.content.strip()
    except Exception as e:
        st.error(f"AIå›ç­”ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")
        return "ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€AIã«ã‚ˆã‚‹å›ç­”ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚"

# --- ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ä¿å­˜ --- #
def append_to_csv(q, a, path="chat_logs.csv"):
    try:
        df = pd.DataFrame([{ "timestamp": pd.Timestamp.now().isoformat(), "question": q, "answer": a }])
        if not os.path.exists(path):
            df.to_csv(path, index=False)
        else:
            df.to_csv(path, mode='a', header=False, index=False)
    except Exception as e:
        st.warning(f"CSVã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")

def append_to_gsheet(q, a):
    try:
        JST = timezone(timedelta(hours=9))
        timestamp = datetime.now(JST).strftime("%Y-%m-%d %H:%M:%S")
        sheet_key = st.secrets["GoogleSheets"]["sheet_key"]
        service_account_info = st.secrets["GoogleSheets"]["service_account_info"]
        if isinstance(service_account_info, str):
            service_account_info = json.loads(service_account_info)
        scopes = [
            "https://www.googleapis.com/auth/spreadsheets",
            "https://www.googleapis.com/auth/drive"
        ]
        creds = Credentials.from_service_account_info(service_account_info, scopes=scopes)
        gc = gspread.authorize(creds)
        sh = gc.open_by_key(sheet_key)
        worksheet = sh.sheet1
        worksheet.append_row([timestamp, q, a], value_input_option="USER_ENTERED")
    except Exception as e:
        st.warning(f"Google Sheetsã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")

# --- ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆæœŸåŒ– --- #
if "chat_log" not in st.session_state:
    st.session_state.chat_log = []

# --- éå»ãƒ­ã‚°è¡¨ç¤º --- #
for q, a in st.session_state.chat_log:
    st.chat_message("user").write(q)
    if a:
        st.chat_message("assistant").write(a)

# --- ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ› --- #
user_q = st.chat_input("è³ªå•ã‚’ã©ã†ã...")

if user_q:
    if not is_valid_input(user_q):
        st.warning("å…¥åŠ›ãŒä¸æ­£ã§ã™ã€‚3ã€œ300æ–‡å­—ã€è¨˜å·ç‡30%æœªæº€ã«ã—ã¦ãã ã•ã„ã€‚")
    else:
        ref_q, ref_a = find_top_similar(user_q, faq_df)
        if ref_q is None:
            answer = "ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€é–¢é€£FAQãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"
        else:
            with st.spinner("å›ç­”ã‚’ç”Ÿæˆä¸­..."):
                answer = generate_response(user_q, ref_q, ref_a)
        st.session_state.chat_log.append((user_q, answer))
        append_to_csv(user_q, answer)
        append_to_gsheet(user_q, answer)
        st.experimental_rerun()
